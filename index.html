<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è–èª•äº¤æ›ç¦®ç‰©</title>
  <link rel="icon" href="img/favicon.ico">
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    /* --- å‹•ç•«å®šç¾© --- */
    @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pop-in { 0% { opacity: 0; transform: scale(0.8); } 70% { transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
    @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes bounce-custom { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    
    .animate-fade-in { animation: fade-in 0.6s ease-out forwards; }
    .animate-pop-in { animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    .animate-spin-slow { animation: spin-slow 8s linear infinite; }
    .animate-bounce-custom { animation: bounce-custom 2s infinite ease-in-out; }

    /* ä¸‹é›ªèˆ‡éŸ³æ¨‚æŒ‰éˆ• */
    .snowflake {
      position: fixed; top: -20px; color: #FFF; user-select: none; pointer-events: none; z-index: 50;
      animation-name: fall; animation-timing-function: linear; animation-iteration-count: infinite;
      text-shadow: 0 0 2px rgba(255,255,255,0.8);
    }
    @keyframes fall { to { transform: translateY(110vh); } }
    .music-playing { animation: spin-slow 3s linear infinite; }
    
    /* å½ˆçª—èƒŒæ™¯æ¨¡ç³Š */
    .blur-bg { filter: blur(5px); transition: filter 0.5s ease; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans overflow-x-hidden">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // --- Firebase è¨­å®š ---
    const firebaseConfig = {
      apiKey: "AIzaSyBu-q_aqdsEAo3paJIbLXj0QQ6Dy-1xJ3Y",
      authDomain: "gift-exchange-app-c891a.firebaseapp.com",
      projectId: "gift-exchange-app-c891a",
      storageBucket: "gift-exchange-app-c891a.firebasestorage.app",
      messagingSenderId: "1030609890092",
      appId: "1:1030609890092:web:262530dca17c358b8bda89"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const appId = 'my-xmas-party-2024';

    // --- åœ–ç¤ºåº« ---
    const Icons = {
      Gift: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>,
      Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
      Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
      UserCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/></svg>,
      CheckCircle2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
      Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
      AlertCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
      Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
      ArrowLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
      KeyRound: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z"/><circle cx="16.5" cy="7.5" r=".5" fill="currentColor"/></svg>,
      Copy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
      Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 6 9 17l-5-5"/></svg>,
      Trees: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M10 10v.2A3 3 0 0 1 8.9 16v0H5v0h0a3 3 0 0 1-1-5.8V10a3 3 0 0 1 5.3-1.3z"/><path d="M7 16v6"/><path d="M13 19v3"/><path d="M12 19h8.3a1 1 0 0 0 .7-1.7L18 14h.3a1 1 0 0 0 .7-1.7L16 9h.2a1 1 0 0 0 .8-1.7L13 3l-1.4 1.5"/></svg>,
      Snowflake: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/><path d="m20 16-4-4 4-4"/><path d="m4 8 4 4-4 4"/><path d="m16 4-4 4-4-4"/><path d="m8 20 4-4 4 4"/></svg>,
      Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
      Ticket: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>,
      X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
      AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
      HelpCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>,
      Music: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>,
      VolumeX: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" x2="17" y1="9" y2="15"/><line x1="17" x2="23" y1="9" y2="15"/></svg>,
      PlayCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>
    };

    // --- å…±ç”¨èƒŒæ™¯åœ–å…ƒä»¶ (å›ºå®šä½ç½®ï¼Œé€æ˜åº¦ 0.3) ---
    const BackgroundImage = () => (
      <div className="fixed inset-0 z-0 pointer-events-none" style={{
        backgroundImage: "url('./9796468.jpg')",
        backgroundSize: 'cover',
        backgroundPosition: 'top center',
        backgroundRepeat: 'no-repeat',
        opacity: 0.3 
      }} />
    );

    // --- éŸ³æ¨‚æ§åˆ¶å™¨ (å« Tooltip) ---
    const MusicController = ({ isPlaying, setPlaying }) => {
        const localSrc = "./bgm.mp3";
        const backupSrc = "https://ia800302.us.archive.org/16/items/JingleBells_773/JingleBells.mp3"; 
        
        const audioRef = useRef(null);

        const toggle = () => {
            const audio = audioRef.current;
            if (!audio) return;
            if (audio.paused) {
                audio.play()
                  .then(() => setPlaying(true))
                  .catch(e => {
                    console.error("æ’­æ”¾å¤±æ•—:", e);
                    alert("ç„¡æ³•æ’­æ”¾éŸ³æ¨‚ï¼\nè«‹ç¢ºèª bgm.mp3 å·²æ­£ç¢ºæ”¾å…¥ã€‚");
                    setPlaying(false);
                  });
            } else {
                audio.pause();
                setPlaying(false);
            }
        };

        useEffect(() => {
          if (isPlaying && audioRef.current && audioRef.current.paused) {
             toggle();
          }
        }, [isPlaying]);

        return (
            <div className="fixed bottom-6 right-6 z-[60] group">
                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-3 px-3 py-1.5 bg-gray-900/90 text-white text-sm font-bold rounded-lg shadow-xl backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0 pointer-events-none whitespace-nowrap">
                    {isPlaying ? 'é—œé–‰éŸ³æ¨‚' : 'é–‹å•ŸéŸ³æ¨‚'}
                    <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900/90"></div>
                </div>

                <audio ref={audioRef} loop src={localSrc} onError={(e) => { e.target.src = backupSrc; }} />
                
                <button onClick={toggle} className={`w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-all transform hover:scale-110 active:scale-95 border-4 border-white ${isPlaying ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-500'}`}>
                    <div className={isPlaying ? 'music-playing' : ''}>
                        {isPlaying ? <Icons.Music className="w-6 h-6" /> : <Icons.VolumeX className="w-6 h-6" />}
                    </div>
                </button>
            </div>
        );
    };

    // --- å½ˆå‡ºå¼å…¥å ´è¦–çª— (Start Modal) ---
    const StartModal = ({ onStart }) => {
      return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-fade-in" />
          <div className="relative bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full text-center animate-pop-in border-4 border-red-100">
             <div className="absolute -top-10 left-1/2 transform -translate-x-1/2">
                <div className="bg-yellow-400 p-4 rounded-full shadow-lg border-4 border-white animate-bounce-custom">
                   <Icons.Gift className="w-12 h-12 text-red-600" />
                </div>
             </div>
             <h2 className="mt-8 text-2xl font-black text-gray-800">æ­¡è¿ä¾†åˆ°<br/>äº¤æ›ç¦®ç‰©æ´¾å°</h2>
             <p className="text-gray-500 mt-2 mb-8">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²å…¥ç¶²é ä¸¦é–‹å•ŸéŸ³æ¨‚</p>
             <button onClick={onStart} className="w-full py-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-red-200 transform transition hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-2">
               <span>é€²å…¥ç¶²é </span> <Icons.PlayCircle className="w-5 h-5" />
             </button>
          </div>
        </div>
      );
    };

    const SnowSystem = () => {
      useEffect(() => {
        const createSnowflake = () => {
          const snow = document.createElement('div');
          snow.classList.add('snowflake');
          snow.innerText = 'â„';
          snow.style.left = Math.random() * 100 + 'vw';
          snow.style.animationDuration = Math.random() * 3 + 3 + 's'; 
          snow.style.opacity = Math.random() * 0.5 + 0.3; 
          snow.style.fontSize = Math.random() * 12 + 10 + 'px'; 
          document.body.appendChild(snow);
          setTimeout(() => snow.remove(), 6000);
        };
        const interval = setInterval(createSnowflake, 200);
        return () => clearInterval(interval);
      }, []);
      return null;
    };

    const ConfirmModal = ({ isOpen, title, content, onConfirm, onCancel, isDanger = false }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-[999] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/50 backdrop-blur-sm" onClick={onCancel} />
          <div className="relative bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-pop-in border border-gray-100">
            <div className={`w-12 h-12 rounded-full flex items-center justify-center mb-4 ${isDanger ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
              {isDanger ? <Icons.AlertTriangle className="w-6 h-6" /> : <Icons.AlertCircle className="w-6 h-6" />}
            </div>
            <h3 className="text-xl font-bold text-gray-900 mb-2">{title}</h3>
            <p className="text-gray-600 mb-6 leading-relaxed">{content}</p>
            <div className="flex gap-3">
              <button onClick={onCancel} className="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button>
              <button onClick={onConfirm} className={`flex-1 px-4 py-2.5 text-white rounded-xl font-bold shadow-lg transition transform active:scale-95 ${isDanger ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700'}`}>ç¢ºå®š</button>
            </div>
          </div>
        </div>
      );
    };

    const BackButton = ({ onClick }) => (
      <button onClick={onClick} className="flex items-center text-gray-500 hover:text-gray-800 font-medium mb-4 transition-colors">
        <span className="mr-1"><Icons.ArrowLeft className="w-4 h-4" /></span> è¿”å›é¦–é 
      </button>
    );

    const RegistrationView = ({ users, collectionRef, goBack }) => {
      const [name, setName] = useState('');
      const [department, setDepartment] = useState('ä¼åŠƒéƒ¨');
      const [giftName, setGiftName] = useState('');
      const [wishes, setWishes] = useState(['', '', '']);
      const [pin, setPin] = useState('');
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [submitted, setSubmitted] = useState(false);
      const [submittedData, setSubmittedData] = useState(null);

      const handleWishChange = (index, value) => {
        const newWishes = [...wishes];
        newWishes[index] = value;
        setWishes(newWishes);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!name.trim() || !giftName.trim() || wishes.some(w => !w.trim()) || pin.length < 4 || !department) {
          alert('æ‰€æœ‰æ¬„ä½éƒ½æ˜¯å¿…å¡«çš„å–”ï¼');
          return;
        }
        if (users.some(u => u.name.trim().toLowerCase() === name.trim().toLowerCase())) {
          alert('é€™å€‹åå­—å·²ç¶“æœ‰äººè¨»å†Šéäº†ï¼');
          return;
        }

        setIsSubmitting(true);
        try {
          const dataToSave = {
            name: name.trim(),
            department,
            giftName: giftName.trim(),
            pin: pin.trim(),
            wishes: wishes.map(w => w.trim()),
            assignedTo: null,
            assignedToName: null,
            assignedToWishes: null,
            createdAt: new Date().toISOString()
          };
          await collectionRef.add(dataToSave);
          setSubmittedData(dataToSave);
          setSubmitted(true);
          setName(''); setGiftName(''); setPin(''); setWishes(['', '', '']);
        } catch (error) {
          console.error(error);
          alert("ç™¼ç”ŸéŒ¯èª¤");
        } finally {
          setIsSubmitting(false);
        }
      };

      if (submitted && submittedData) {
        return (
          <div className="max-w-md mx-auto pt-4 animate-fade-in">
            <div className="bg-white p-8 rounded-2xl shadow-xl text-center space-y-6 border-t-4 border-green-500">
              <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto text-green-600"><Icons.CheckCircle2 className="w-8 h-8" /></div>
              <div><h2 className="text-2xl font-bold text-gray-800 mb-2">å¡«å¯«å®Œæˆ</h2><p className="text-gray-500 text-sm">è«‹æˆªåœ–ä¿å­˜æ‚¨çš„è³‡æ–™èˆ‡å¯†ç¢¼</p></div>
              <div className="bg-gray-50 rounded-xl p-5 text-left space-y-3 border border-gray-200 relative overflow-hidden">
                <div className="absolute top-0 right-0 bg-gray-200 text-gray-500 text-xs px-2 py-1 rounded-bl-lg">å·²å­˜æª”</div>
                <div><label className="text-xs text-gray-400 uppercase font-bold">å§“å</label><div className="font-bold text-lg text-gray-800 flex items-center gap-2">{submittedData.name}<span className={`text-xs px-2 py-0.5 rounded-full ${submittedData.department === 'ä¼åŠƒéƒ¨' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>{submittedData.department}</span></div></div>
                <div><label className="text-xs text-gray-400 uppercase font-bold">æƒ³è¦çš„ç¦®ç‰©</label><div className="text-gray-800 font-medium border-b border-gray-200 pb-1">{submittedData.giftName}</div></div>
                <div><label className="text-xs text-gray-400 uppercase font-bold">æŸ¥è©¢å¯†ç¢¼</label><div className="font-mono text-xl font-bold text-indigo-600 tracking-widest">{submittedData.pin}</div></div>
              </div>
              <div className="pt-4"><button onClick={goBack} className="w-full px-6 py-3 bg-gray-900 text-white rounded-xl hover:bg-gray-800 font-bold shadow-lg transform transition active:scale-95">å›é¦–é </button></div>
            </div>
          </div>
        );
      }

      return (
        <div className="max-w-md mx-auto animate-fade-in">
          <BackButton onClick={goBack} />
          <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
            <div className="bg-gradient-to-r from-green-600 to-emerald-600 p-6 text-white text-center">
              <div className="mx-auto mb-2 flex justify-center"><Icons.Gift className="w-12 h-12" /></div>
              <h2 className="text-2xl font-bold">ç¦®ç‰©é—œéµå­—å¡«å¯«</h2><p className="opacity-90 text-sm">æ‰€æœ‰æ¬„ä½çš†ç‚ºå¿…å¡«</p>
            </div>
            <form onSubmit={handleSubmit} className="p-6 space-y-5">
              <div><label className="block text-sm font-medium text-gray-700 mb-1">å§“å <span className="text-red-500">*</span></label><input type="text" required value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 outline-none" placeholder="ä¾‹å¦‚ï¼šç‹å°ç¾" /></div>
              <div className="grid grid-cols-2 gap-4">
                <div><label className="block text-sm font-medium text-gray-700 mb-1">æ‰€å±¬éƒ¨é–€ <span className="text-red-500">*</span></label><div className="flex gap-2"><button type="button" onClick={() => setDepartment('ä¼åŠƒéƒ¨')} className={`flex-1 py-2 rounded-lg border-2 font-bold text-sm transition ${department === 'ä¼åŠƒéƒ¨' ? 'border-red-500 bg-red-50 text-red-600' : 'border-gray-200 text-gray-400'}`}>ä¼åŠƒéƒ¨</button><button type="button" onClick={() => setDepartment('æ•¸ä½éƒ¨')} className={`flex-1 py-2 rounded-lg border-2 font-bold text-sm transition ${department === 'æ•¸ä½éƒ¨' ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-gray-200 text-gray-400'}`}>æ•¸ä½éƒ¨</button></div></div>
                <div><label className="block text-sm font-medium text-gray-700 mb-1">æŸ¥è©¢å¯†ç¢¼ <span className="text-xs text-gray-500 font-normal">(4ä½æ•¸å­—) <span className="text-red-500">*</span></span></label><div className="relative"><span className="absolute left-3 top-2.5 text-gray-400"><Icons.KeyRound className="w-4 h-4" /></span><input type="text" required value={pin} maxLength={4} onChange={(e) => setPin(e.target.value.replace(/\D/g,''))} className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 outline-none font-mono tracking-widest" placeholder="0000" /></div></div>
              </div>
              <div className="bg-gray-50 p-4 rounded-xl border border-gray-100">
                <label className="block text-sm font-bold text-gray-800 mb-1">ä½ æƒ³è¦çš„ç¦®ç‰©åç¨± <span className="text-gray-500 font-normal">(ä¿å¯†)</span> <span className="text-red-500">*</span></label>
                <input type="text" required value={giftName} onChange={(e) => setGiftName(e.target.value)} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 outline-none mb-1" placeholder="ä¾‹å¦‚ï¼šç„¡ç·šè—ç‰™è€³æ©Ÿ" />
              </div>
              <div className="space-y-3">
                <label className="block text-sm font-bold text-gray-800">çµ¦å°å¤©ä½¿çš„ä¸‰å€‹æç¤º <span className="text-red-500">*</span></label>
                {wishes.map((wish, idx) => (
                  <div key={idx} className="relative"><span className="absolute left-3 top-2.5 text-gray-400 text-sm font-mono">#{idx + 1}</span><input type="text" required value={wish} onChange={(e) => handleWishChange(idx, e.target.value)} className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-400 outline-none" placeholder={`æç¤º ${idx + 1}`} /></div>
                ))}
              </div>
              <button type="submit" disabled={isSubmitting} className="w-full mt-4 bg-gray-900 text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition transform active:scale-[0.98]">{isSubmitting ? 'é€å‡ºè³‡æ–™' : 'é€å‡ºä¸¦è¨­å®šå¯†ç¢¼'}</button>
            </form>
          </div>
        </div>
      );
    };

    const ResultView = ({ users, goBack }) => {
      const [selectedUserId, setSelectedUserId] = useState('');
      const [inputPin, setInputPin] = useState('');
      const [isUnlocked, setIsUnlocked] = useState(false);
      const [isRevealed, setIsRevealed] = useState(false);
      const [isAnimating, setIsAnimating] = useState(false);
      const [errorMsg, setErrorMsg] = useState('');
      
      const currentUserData = users.find(u => u.id === selectedUserId);
      const hasDrawHappened = currentUserData && currentUserData.assignedTo;

      const handleUserChange = (e) => { setSelectedUserId(e.target.value); setInputPin(''); setIsUnlocked(false); setIsRevealed(false); setErrorMsg(''); };
      const handleUnlock = (e) => {
        e.preventDefault();
        if (!currentUserData) return;
        if (inputPin === currentUserData.pin) { setIsUnlocked(true); setErrorMsg(''); } else { setErrorMsg('å¯†ç¢¼éŒ¯èª¤'); setInputPin(''); }
      };
      const handleReveal = () => {
        if (!hasDrawHappened) return;
        setIsAnimating(true);
        setTimeout(() => { setIsAnimating(false); setIsRevealed(true); }, 1500);
      };

      // åˆ¤æ–·éƒ¨é–€é¡è‰² (ç´…/è—)
      const isAssignedDeptPlanning = currentUserData && (currentUserData.assignedToDepartment === 'ä¼åŠƒéƒ¨' || currentUserData.assignedToDepartment === 'A');
      const deptBadgeClass = isAssignedDeptPlanning 
        ? "bg-red-100 text-red-600 border-red-200" 
        : "bg-blue-100 text-blue-600 border-blue-200";

      return (
        <div className="max-w-md mx-auto animate-fade-in">
          <BackButton onClick={goBack} />
          {/* å¤–å±¤åŠ ä¸Š relative */}
          <div className="bg-white rounded-2xl shadow-xl min-h-[500px] flex flex-col relative">
            
            {/* é ‚éƒ¨åœ“è§’ */}
            <div className="bg-indigo-600 p-6 text-white text-center rounded-t-2xl">
              <div className="flex justify-center mb-2 text-indigo-200">{isUnlocked ? <Icons.Search className="w-10 h-10" /> : <Icons.Lock className="w-10 h-10" />}</div>
              <h2 className="text-xl font-bold">{isUnlocked ? 'æŸ¥è©¢ä½ çš„å°ä¸»äºº' : 'èº«ä»½é©—è­‰'}</h2>
            </div>
            <div className="p-6 flex-1 flex flex-col">
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">æˆ‘æ˜¯...</label>
                <select value={selectedUserId} onChange={handleUserChange} disabled={isUnlocked} className="w-full p-3 border border-gray-300 rounded-xl text-lg outline-none focus:ring-2 focus:ring-indigo-400 bg-gray-50 disabled:opacity-70">
                  <option value="">è«‹é¸æ“‡ä½ çš„åå­—</option>
                  {users.map(user => <option key={user.id} value={user.id}>{user.name} ({user.department})</option>)}
                </select>
              </div>
              {selectedUserId && !isUnlocked && (
                <form onSubmit={handleUnlock} className="animate-fade-in mt-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">è«‹è¼¸å…¥å ±åæ™‚è¨­å®šçš„å¯†ç¢¼</label>
                  <div className="flex gap-2"><input type="password" value={inputPin} onChange={(e) => setInputPin(e.target.value)} className="flex-1 p-3 border border-gray-300 rounded-xl text-center tracking-widest text-lg outline-none focus:ring-2 focus:ring-indigo-400" placeholder="****" maxLength={4} /><button type="submit" className="px-6 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">è§£é–</button></div>
                  {errorMsg && <p className="text-red-500 text-sm mt-2 flex items-center"><Icons.AlertCircle className="w-4 h-4" /><span className="ml-1">{errorMsg}</span></p>}
                </form>
              )}
              {selectedUserId && isUnlocked && (
                <div className="flex-1 flex items-center justify-center animate-fade-in">
                  {!hasDrawHappened ? (
                    <div className="text-center p-8 bg-gray-50 rounded-xl w-full"><div className="mx-auto mb-3 text-gray-400 flex justify-center"><Icons.AlertCircle className="w-12 h-12" /></div><h3 className="font-bold text-gray-600 text-lg">å°šæœªé€²è¡Œé…å°</h3><p className="text-sm text-gray-500">ä¸»æŒäººé‚„æ²’æŒ‰ä¸‹é–‹å§‹æŒ‰éˆ•</p></div>
                  ) : (
                    <div className="w-full">
                      {!isRevealed ? (
                        <div className="text-center py-8">
                          <button onClick={handleReveal} disabled={isAnimating} className={`group relative w-40 h-40 mx-auto bg-yellow-100 rounded-3xl flex items-center justify-center cursor-pointer transition-all duration-300 hover:scale-105 hover:rotate-3 active:scale-95 ${isAnimating ? 'animate-bounce' : ''}`}>
                             <div className={`text-yellow-600 transition-all ${isAnimating ? 'scale-110' : 'group-hover:scale-110'}`}><Icons.Gift className="w-20 h-20" /></div>
                             {isAnimating && <span className="absolute -top-4 -right-4 text-2xl animate-ping">âœ¨</span>}
                          </button>
                          <p className="mt-6 text-gray-600 font-medium">{isAnimating ? 'æ­£åœ¨æ‹†ç¦®ç‰©...' : 'é»æ“Šç¦®ç‰©ç›’æ­æ›‰çµæœï¼'}</p>
                        </div>
                      ) : (
                        <div className="animate-pop-in bg-gradient-to-br from-yellow-50 to-orange-100 border-2 border-yellow-200 rounded-2xl p-6 shadow-inner relative">
                          
                          <div className="absolute -top-6 -right-6 text-5xl animate-bounce z-20 select-none drop-shadow-lg filter">ğŸ‰</div>
                          
                          <h3 className="text-center text-yellow-800 font-bold mb-1">æ­å–œä½ ï¼</h3>
                          <p className="text-center text-yellow-700 text-sm mb-6">ä½ çš„é€ç¦®å°è±¡æ˜¯...</p>
                          <div className="bg-white rounded-xl p-4 mb-4 shadow-sm flex items-center gap-4">
                            <div className="bg-red-100 p-3 rounded-full text-4xl flex items-center justify-center w-16 h-16 shadow-inner">ğŸ…</div>
                            <div>
                                <span className={`text-xs font-bold border px-2 py-0.5 rounded-full ${deptBadgeClass}`}>
                                    {currentUserData.assignedToDepartment}
                                </span>
                                <div className="font-black text-2xl text-gray-800 mt-1">{currentUserData.assignedToName}</div>
                            </div>
                          </div>
                          <div className="bg-white/60 rounded-xl p-4">
                            <p className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">çµ¦ä½ çš„ä¸‰å€‹æç¤º</p>
                            <ul className="space-y-2 pl-2">
                              {currentUserData.assignedToWishes && currentUserData.assignedToWishes.map((wish, idx) => (
                                <li key={idx} className="flex items-start gap-2 text-gray-700 font-medium">
                                  <span className="flex-shrink-0 select-none">ğŸ</span>
                                  <span>{wish}</span>
                                </li>
                              ))}
                            </ul>
                          </div>
                          <button onClick={() => setIsRevealed(false)} className="w-full mt-4 text-sm text-yellow-700 hover:underline">å†çœ‹ä¸€æ¬¡å‹•ç•«</button>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const AdminView = ({ users, collectionRef, goBack }) => {
      const [isAuthorized, setIsAuthorized] = useState(false);
      const [password, setPassword] = useState('');
      const [isProcessing, setIsProcessing] = useState(false);
      const [copied, setCopied] = useState(false);
      const [modalConfig, setModalConfig] = useState({ isOpen: false, title: '', content: '', onConfirm: null, isDanger: false });

      const deptA = users.filter(u => u.department === 'ä¼åŠƒéƒ¨' || u.department === 'A');
      const deptB = users.filter(u => u.department === 'æ•¸ä½éƒ¨' || u.department === 'B');
      const hasResults = users.some(u => u.assignedTo);

      const handleLogin = (e) => { e.preventDefault(); if (password === '8888') setIsAuthorized(true); else { alert('å¯†ç¢¼éŒ¯èª¤'); setPassword(''); } };
      const shuffle = (array) => {
        let currentIndex = array.length, randomIndex;
        while (currentIndex !== 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; }
        return array;
      };

      const executeDraw = async () => {
        setModalConfig(prev => ({ ...prev, isOpen: false }));
        setIsProcessing(true);
        const batch = db.batch();
        try {
          const shuffledA = shuffle([...deptA]);
          const shuffledB = shuffle([...deptB]);
          if (shuffledA.length === 0 || shuffledB.length === 0) {
            const all = [...shuffledA, ...shuffledB];
            const shuffledAll = shuffle(all);
            for (let i = 0; i < shuffledAll.length; i++) {
              const giver = shuffledAll[i];
              const receiver = shuffledAll[(i + 1) % shuffledAll.length];
              batch.update(collectionRef.doc(giver.id), { assignedTo: receiver.id, assignedToName: receiver.name, assignedToDepartment: receiver.department, assignedToWishes: receiver.wishes });
            }
          } else {
            const minSize = Math.min(shuffledA.length, shuffledB.length);
            const leftovers = [];
            for (let i = 0; i < minSize; i++) {
              const pA = shuffledA[i];
              const pB = shuffledB[i];
              batch.update(collectionRef.doc(pA.id), { assignedTo: pB.id, assignedToName: pB.name, assignedToDepartment: pB.department, assignedToWishes: pB.wishes });
              const targetA = shuffledA[(i + 1) % minSize];
              batch.update(collectionRef.doc(pB.id), { assignedTo: targetA.id, assignedToName: targetA.name, assignedToDepartment: targetA.department, assignedToWishes: targetA.wishes });
            }
            if (shuffledA.length > minSize) leftovers.push(...shuffledA.slice(minSize));
            if (shuffledB.length > minSize) leftovers.push(...shuffledB.slice(minSize));
            if (leftovers.length > 0) {
                 const shuffledLeftovers = shuffle(leftovers);
                 for (let i = 0; i < shuffledLeftovers.length; i++) {
                   const giver = shuffledLeftovers[i];
                   const receiver = shuffledLeftovers[(i + 1) % shuffledLeftovers.length];
                   if (giver.id === receiver.id && shuffledLeftovers.length === 1) {
                      batch.update(collectionRef.doc(giver.id), { assignedTo: giver.id, assignedToName: giver.name, assignedToDepartment: giver.department, assignedToWishes: ['æ²’äººå¯æŠ½ï¼Œåªå¥½æ„›è‡ªå·±'] });
                   } else {
                      batch.update(collectionRef.doc(giver.id), { assignedTo: receiver.id, assignedToName: receiver.name, assignedToDepartment: receiver.department, assignedToWishes: receiver.wishes });
                   }
                 }
            }
          }
          await batch.commit();
        } catch (error) { console.error(error); alert('å¤±æ•—: ' + error.message); } finally { setIsProcessing(false); }
      };

      const confirmDraw = () => {
        if (users.length < 2) { alert('åƒåŠ äººæ•¸éå°‘'); return; }
        setModalConfig({ isOpen: true, title: 'ç¢ºèªé–‹å§‹æŠ½ç±¤ï¼Ÿ', content: 'ç³»çµ±å°‡æœƒæ‰“äº‚é †åºä¸¦é€²è¡Œè‡ªå‹•é…å°ã€‚', onConfirm: executeDraw, onCancel: () => setModalConfig(prev => ({ ...prev, isOpen: false })), isDanger: false });
      };
      const executeReset = async () => {
        setModalConfig(prev => ({ ...prev, isOpen: false }));
        setIsProcessing(true);
        try { for (const user of users) { await collectionRef.doc(user.id).delete(); } } catch (e) { console.error(e); } finally { setIsProcessing(false); }
      };
      const confirmReset = () => setModalConfig({ isOpen: true, title: 'âš ï¸ è­¦å‘Šï¼šæ¸…ç©ºæ‰€æœ‰è³‡æ–™', content: 'ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ', onConfirm: executeReset, onCancel: () => setModalConfig(prev => ({ ...prev, isOpen: false })), isDanger: true });
      const executeDeleteUser = async (userId) => {
         setModalConfig(prev => ({ ...prev, isOpen: false }));
         try { await collectionRef.doc(userId).delete(); } catch (error) { console.error("Error:", error); alert("åˆªé™¤å¤±æ•—"); }
      };
      const confirmDeleteUser = (userId, userName) => setModalConfig({ isOpen: true, title: 'åˆªé™¤åƒåŠ è€…', content: `ç¢ºå®šè¦åˆªé™¤ã€Œ${userName}ã€å—ï¼Ÿ`, onConfirm: () => executeDeleteUser(userId), onCancel: () => setModalConfig(prev => ({ ...prev, isOpen: false })), isDanger: true });
      
      const handleCopyResults = () => {
        if (users.length === 0 || !hasResults) return;
        let text = "ğŸ„ äº¤æ›ç¦®ç‰©çµæœ ğŸ„\n\n";
        users.forEach(u => { text += `å§“åï¼š${u.name}\nå°å¤©ä½¿ï¼š${u.assignedToName}\n----------------\n`; });
        navigator.clipboard.writeText(text).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); });
      };

      if (!isAuthorized) return (
        <div className="max-w-sm mx-auto mt-10 animate-fade-in"><BackButton onClick={goBack} />
          <div className="bg-white p-8 rounded-2xl shadow-lg text-center"><div className="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-500"><Icons.Lock className="w-8 h-8" /></div><h3 className="text-xl font-bold mb-1">ä¸»æŒäººå°ˆç”¨</h3><p className="text-gray-500 text-sm mb-6">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼</p><form onSubmit={handleLogin}><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-2 text-center border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-gray-500 outline-none tracking-widest" placeholder="â—â—â—â—" /><button type="submit" className="w-full bg-black text-white py-2 rounded-lg font-bold">é€²å…¥å¾Œå°</button></form></div></div>
      );

      return (
        <div className="max-w-6xl mx-auto animate-fade-in relative">
          <ConfirmModal isOpen={modalConfig.isOpen} title={modalConfig.title} content={modalConfig.content} onConfirm={modalConfig.onConfirm} onCancel={modalConfig.onCancel} isDanger={modalConfig.isDanger} />
          <div className="flex justify-between items-center mb-6"><BackButton onClick={goBack} /><div className="flex items-center gap-2 bg-yellow-100 px-3 py-1 rounded-full text-yellow-800 text-xs font-bold"><Icons.Lock className="w-3 h-3" /> ç®¡ç†å“¡æ¨¡å¼</div></div>
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div className="lg:col-span-1 space-y-6">
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 sticky top-6"><h2 className="text-lg font-bold text-gray-800 mb-4">æ´»å‹•æ§åˆ¶å°</h2>
                <div className="grid grid-cols-2 gap-3 mb-6"><div className="bg-red-50 p-3 rounded-lg text-center border border-red-100"><span className="text-xs text-red-600 font-bold uppercase">ä¼åŠƒéƒ¨</span><div className="text-2xl font-black text-red-700">{deptA.length}</div></div><div className="bg-blue-50 p-3 rounded-lg text-center border border-blue-100"><span className="text-xs text-blue-600 font-bold uppercase">æ•¸ä½éƒ¨</span><div className="text-2xl font-black text-blue-700">{deptB.length}</div></div></div>
                <button onClick={confirmDraw} className={`w-full flex items-center justify-center gap-2 px-6 py-3 text-white rounded-xl font-bold shadow-md mb-3 transition active:scale-95 ${isProcessing ? 'bg-gray-400 cursor-wait' : 'bg-indigo-600 hover:bg-indigo-700'}`}><span className="text-xl"><Icons.Ticket className="w-5 h-5" /></span>{isProcessing ? 'è™•ç†ä¸­...' : (hasResults ? 'é‡æ–°æŠ½ç±¤' : 'æŠ½ç±¤')}</button>
                {hasResults && <button onClick={handleCopyResults} className="w-full flex items-center justify-center gap-2 px-6 py-3 bg-white text-gray-700 border border-gray-300 rounded-xl hover:bg-gray-50 font-bold shadow-sm mb-3 transition">{copied ? <span className="text-green-600"><Icons.Check className="w-4 h-4" /></span> : <Icons.Copy className="w-4 h-4" />}{copied ? 'å·²è¤‡è£½ï¼' : 'è¤‡è£½æ‰€æœ‰çµæœ'}</button>}
                <button onClick={confirmReset} className="w-full flex items-center justify-center gap-2 px-4 py-2 text-red-600 border border-red-200 rounded-xl hover:bg-red-50 text-sm font-medium transition"><Icons.Trash2 className="w-4 h-4" /> æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
              </div>
            </div>
            <div className="lg:col-span-3">
              <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden"><div className="bg-gray-50 px-6 py-4 border-b border-gray-100"><h3 className="font-bold text-gray-700">åƒåŠ è€…åå–® ({users.length})</h3></div><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="text-xs text-gray-500 uppercase bg-gray-50"><tr><th className="px-6 py-3 w-1/5">åƒåŠ è€…</th><th className="px-6 py-3 w-1/5">ç¦®ç‰©åç¨± (ä¿å¯†)</th><th className="px-6 py-3 w-1/4">ç¦®ç‰©é—œéµå­—</th><th className="px-6 py-3 w-1/6">å¯†ç¢¼</th><th className="px-6 py-3 w-1/5">é…å°çµæœ</th><th className="px-6 py-3 w-16">æ“ä½œ</th></tr></thead><tbody className="divide-y divide-gray-100">{users.map((user) => (<tr key={user.id} className="hover:bg-gray-50"><td className="px-6 py-4 align-top"><div className="flex items-center gap-2"><span className={`w-2 h-2 rounded-full ${user.department === 'ä¼åŠƒéƒ¨' || user.department === 'A' ? 'bg-red-500' : 'bg-blue-500'}`} /><div><div className="font-bold text-gray-800">{user.name}</div><div className="text-xs text-gray-400">({user.department})</div></div></div></td><td className="px-6 py-4 align-top text-gray-800 font-medium">{user.giftName || <span className="text-gray-400 text-xs">æœªå¡«å¯«</span>}</td><td className="px-6 py-4 align-top"><div className="space-y-1">{user.wishes.map((wish, i) => (<div key={i} className="flex items-start gap-1 text-gray-600"><span className="text-gray-300 text-xs mt-1">â€¢</span><span>{wish}</span></div>))}</div></td><td className="px-6 py-4 align-top text-gray-400 font-mono">{user.pin || 'ç„¡'}</td><td className="px-6 py-4 align-top">{user.assignedToName ? (<div className="bg-indigo-50 rounded-lg p-2"><div className="text-xs text-indigo-400 mb-1">ä½ çš„å°å¤©ä½¿ğŸ‘¼</div><div className="font-bold text-indigo-700">{user.assignedToName}</div></div>) : (<span className="text-gray-300 text-xs">æœªé…å°</span>)}</td><td className="px-6 py-4 align-top text-center"><button onClick={() => confirmDeleteUser(user.id, user.name)} className="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors" title="åˆªé™¤æ­¤äºº"><Icons.Trash2 className="w-5 h-5" /></button></td></tr>))}</tbody></table></div></div>
            </div>
          </div>
        </div>
      );
    };

    // --- é¦–é å…¥å£ (ä½¿ç”¨ BackgroundImage å…ƒä»¶) ---
    const HomePortal = ({ onNavigate }) => (
      <div className="min-h-screen flex items-end justify-center pb-20 md:pb-48 p-4 relative overflow-hidden">
        {/* åŠ å…¥èƒŒæ™¯åœ– */}
        <BackgroundImage />
        
        <div className="absolute top-10 left-10 opacity-20 animate-pulse text-blue-300"><Icons.Snowflake className="w-12 h-12" /></div>
        <div className="absolute bottom-20 right-20 opacity-20 animate-pulse text-blue-300" style={{animationDelay: '1s'}}><Icons.Snowflake className="w-16 h-16" /></div>
        <div className="absolute top-1/4 left-5 opacity-30 animate-bounce text-red-400" style={{animationDuration: '3s'}}><Icons.Gift className="w-10 h-10" /></div>
        <div className="absolute bottom-1/3 left-10 opacity-20 animate-bounce text-yellow-500" style={{animationDuration: '4s'}}><Icons.Gift className="w-8 h-8" /></div>
        
        <div className="max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-center relative z-10">
          <div className="space-y-6 animate-fade-in">
            <div className="inline-block p-3 bg-red-100 rounded-2xl text-red-600 mb-2 shadow-inner"><Icons.Gift className="w-8 h-8" /></div>
            
            {/* ä¿®æ”¹è™•ï¼šèª¿æ•´å­—é«”å¤§å°ä¸¦å¼·åˆ¶ä¸æ›è¡Œ */}
            <h1 className="text-3xl sm:text-4xl md:text-5xl font-black text-gray-900 leading-tight">
                è–èª•äº¤æ›ç¦®ç‰©<br />
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-red-600 whitespace-nowrap">
                    åœ‹å°ä¼åŠƒéƒ¨ x æ•¸ä½éƒ¨
                </span>
            </h1>
            
            <p className="text-lg text-gray-600">Ho Ho Ho! æ­¡è¿ä¾†åˆ°å°å¤©ä½¿å°ä¸»äººäº¤æ›ç¦®ç‰©æ´¾å°ã€‚<br/>è«‹é¸æ“‡åŠŸèƒ½é€²å…¥ï¼š</p>
            <div className="flex flex-col sm:flex-row gap-4 pt-4">
              <button onClick={() => onNavigate('register')} className="px-8 py-4 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-green-200 transform transition hover:-translate-y-1 active:scale-95 border-b-4 border-green-800">ç¦®ç‰©é—œéµå­—å¡«å¯«</button>
              <button onClick={() => onNavigate('result')} className="px-8 py-4 bg-white text-gray-900 border-2 border-gray-200 rounded-xl font-bold text-lg shadow-sm hover:border-red-300 hover:text-red-600 transform transition hover:-translate-y-1 active:scale-95"><div className="flex items-center"><span className="mr-2 text-gray-400"><Icons.Lock className="w-4 h-4" /></span> æŸ¥çœ‹æˆ‘çš„çµæœ</div></button>
            </div>
            <div className="pt-8 border-t border-gray-200"><button onClick={() => onNavigate('admin')} className="flex items-center text-gray-400 hover:text-gray-600 text-sm font-medium transition"><span className="mr-1"><Icons.Lock className="w-4 h-4" /></span> æ´»å‹•ä¸»æŒäººå…¥å£</button></div>
          </div>
          
          <div className="hidden md:flex justify-center animate-fade-in delay-100 mt-10">
            <div className="relative transform scale-125 origin-center">
              <div className="relative z-10 flex flex-col items-center">
                <span className="text-yellow-400 fill-yellow-400 animate-bounce mb-[-10px] z-20"><Icons.Star className="w-12 h-12" /></span>
                <div className="text-green-600 drop-shadow-2xl"><Icons.Trees width="256" height="256" /></div>
                <div className="flex gap-4 mt-[-30px] z-30">
                  <div className="text-red-500 fill-red-100 rotate-[-10deg]"><Icons.Gift className="w-12 h-12" /></div>
                  <div className="text-blue-500 fill-blue-100 rotate-[5deg]"><Icons.Gift className="w-10 h-10" /></div>
                  <div className="text-yellow-500 fill-yellow-100 rotate-[15deg]"><Icons.Gift className="w-14 h-14" /></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );

    const App = () => {
      const [user, setUser] = useState(null);
      const [usersData, setUsersData] = useState([]);
      const [loading, setLoading] = useState(true);
      const [currentView, setCurrentView] = useState('home');
      const [musicPlaying, setMusicPlaying] = useState(false);
      const [showStartModal, setShowStartModal] = useState(true);

      const handleStart = () => {
        const audio = document.getElementById('bgm-audio');
        if (audio) { audio.play().catch(e => console.log("Play failed", e)); }
        setMusicPlaying(true);
        setShowStartModal(false);
      };

      useEffect(() => {
        if (auth.currentUser) { setUser(auth.currentUser); }
        else { auth.signInAnonymously().then(u => setUser(u.user)).catch(e => console.error(e)); }
        return auth.onAuthStateChanged(u => setUser(u));
      }, []);

      const collectionRef = useMemo(() => db.collection('artifacts').doc(appId).collection('participants'), []);

      useEffect(() => {
        if (!user) return;
        return collectionRef.onSnapshot(snapshot => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          data.sort((a, b) => a.createdAt > b.createdAt ? 1 : -1);
          setUsersData(data);
          setLoading(false);
        });
      }, [user, collectionRef]);

      if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500"></div></div>;

      return (
        <div className="min-h-screen font-sans text-gray-800 bg-gray-50 relative">
          <SnowSystem />
          <MusicController isPlaying={musicPlaying} setPlaying={setMusicPlaying} />
          {showStartModal && <StartModal onStart={handleStart} />}
          <div className={showStartModal ? "blur-bg" : "blur-bg blur-none"}>
            {currentView === 'home' && <HomePortal onNavigate={setCurrentView} />}
            {currentView !== 'home' && (
                <div className="min-h-screen py-8 px-4">
                  {currentView === 'register' && <RegistrationView users={usersData} collectionRef={collectionRef} goBack={() => setCurrentView('home')} />}
                  {currentView === 'result' && <ResultView users={usersData} goBack={() => setCurrentView('home')} />}
                  {currentView === 'admin' && <AdminView users={usersData} collectionRef={collectionRef} goBack={() => setCurrentView('home')} />}
                </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
